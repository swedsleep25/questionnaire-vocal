<!--
  VERSION DU QUESTIONNAIRE
  ------------------------
  Version 32
  √Ä CHAQUE MISE √Ä JOUR :
    - Mettre √† jour le num√©ro dans <title>
    - Mettre √† jour la version affich√©e (haut, bas de page)
    - Mettre √† jour le param√®tre version dans l‚Äôappel du module JS (?v=32)
-->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Questionnaire DSM-5 (Voix) -v30 </title>
  <style>
    /* Responsive Design pour smartphone (max-width: 700px) */
    /* Rend les questions, r√©ponses et boutons adaptatifs */
    @media (max-width: 700px) {
      body { margin: 0.5em; }
      #main, #questionnaire, #summary {
        padding: 0.6em; max-width: 99vw; margin: 0.5em auto 0.5em auto;
        border-radius: 0.8em; box-shadow: 0 2px 8px #0056cc22;
      }
      #question { font-size: 1em; padding: 0.3em 0.1em; }
      textarea#inputResponse {
        width: 99vw !important; max-width: 99vw !important; font-size: 1.13em; min-height: 2.4em;
      }
      button { width: 97vw; min-width: 120px; font-size: 1em; padding: 0.8em 0.2em; }
    }
    body { font-family: Arial, sans-serif; margin: 2em; background: #f9f9f9; }
    #main, #questionnaire, #summary { background: #fff; padding: 2em; border-radius: 1em; box-shadow: 0 2px 10px #0056cc22; max-width: 650px; margin: 3em auto 2em; }
    h1, h2 { color: #0056cc; font-weight: bold; }
    #status { color: #c00; font-weight: bold; margin-bottom: 1em; }
    #answersList { text-align: left; }
    input[type="text"] { padding: 0.5em; font-size: 1.1em; border-radius: 5px; border: 1px solid #bbb; margin: 0.7em 1em 0.7em 0; width: 7em; }
    button { background: #0056cc; color: #fff; border: none; border-radius: 1em; padding: 0.7em 1.7em; font-size: 1.1em; margin: 0.7em 0.7em 0 0; cursor: pointer; }
    button:disabled { background: #aaa; }
    #globalComment { width: 98%; min-height: 40px; font-size: 1.05em; padding: 0.5em; border-radius: 0.6em; border: 1px solid #bbb; margin-top: 0.7em; }
    #vocalTip {
      font-size:1.13em; margin:0.8em 0 1.2em 0; color:#b30000;
      background: #fff8c2; border-left: 6px solid #ff9900;
      padding: 0.6em 1em; font-weight: bold; display: block;
    }
  </style>
</head>
<body>
  <div id="main">
    <h1>Questionnaire DSM-5 (Voix)</h1>
 <!-- Affichage de la version juste sous le titre -->
    <div style="font-size:0.9em; color:#888; text-align:right; margin-bottom:1em;">
      Version 32
    </div>
    <div style="margin:1.5em 0">

 <button id="btnCommencer" style="font-size:1.22em;padding:0.9em 3em;">Commencer</button> 

    </div>
    <div id="intro" style="display:none;">
      <div id="introText"></div>
      <p>
        <label for="codeInput"><b>Code √† 4 chiffres :</b></label><br>
        <input type="text" id="codeInput" maxlength="4" pattern="[0-9]{4}" autocomplete="off" />
      </p>
      <button id="startBtn">D√©marrer le questionnaire</button>
      <div id="status"></div>
    </div>
  </div>

  <div id="questionnaire" style="display:none;">
    <div id="partLabel" style="font-size:1.13em;color:#0056cc;margin-bottom:1em;"></div>
    <div id="vocalTip"></div>
    <p id="question"></p>
  </div>

  <div id="summary" style="display:none;">
    <h2>Merci !</h2>
    <p>Voici vos r√©ponses :</p>
    <ul id="answersList"></ul>
    <label for="globalComment">Commentaire global (facultatif) :</label>
    <textarea id="globalComment" placeholder="Vous pouvez ajouter un commentaire libre ici ..."></textarea>
    <br>
    <button id="copyBtn">Copier les r√©ponses</button>
    <button id="pdfBtn">Exporter en PDF</button>
  </div>

<script>
// ---------------------------------
// CHOISIR LE MODULE DE QUESTIONS ICI
// ---------------------------------
//
let microActif = true; // ‚Üê ici, visible partout dans le script
// ici COMMENCE le module de questions

let questions = [
  // ... toutes les questions ici

// Section 1 
  { section: 1, text: "Quel est votre √¢ge?" },
  { text: "Quel est votre sexe ?" },
  { text: "Quel est votre profession ?" },

  // Section 2 Antecedents medicaux
  { section: 2, text: "Y a-t-il des ant√©c√©dents m√©dicaux connus ? Si oui, veuillez pr√©ciser." },
  { text: "Des traitements <b>m√©dicamenteux</b> sont-ils actuellement suivis ? Si oui, veuillez indiquer lesquels, y compris les m√©dicaments sans ordonnance et les compl√©ments alimentaires." },

  // Section 3 Anxi√©t√©
  { section: 3, text: "Ressentez-vous de la nervosit√©, de l‚Äôanxi√©t√© ou une tension excessive ?" },
  { text: "Avez-vous tendance √† vous inqui√©ter excessivement pour diverses choses, ou √† ne pas pouvoir contr√¥ler vos inqui√©tudes ?" },
  { text: "Avez-vous des difficult√©s √† vous concentrer, par exemple en lisant ou en regardant la t√©l√©vision ?" },
  { text: "Vous sentez-vous agit√©, avez-vous du mal √† rester assis tranquillement ?" },
  { text: "Observez-vous des troubles de l‚Äôapp√©tit, tels qu‚Äôune perte ou une augmentation de l‚Äôapp√©tit ?" },
  { text: "Ressentez-vous un sentiment d‚Äô√©chec ou d‚Äôavoir d√©√ßu vous-m√™me ou votre entourage ?" },

  // Section 4 Depression
  { section: 4, text: "Manquez-vous d‚Äôint√©r√™t ou de plaisir √† faire des choses qui vous plaisaient auparavant ?" },
  { text: "Ressentez-vous une humeur d√©pressive, une tristesse ou un sentiment de d√©sespoir ?" },
  { text: "Vous sentez-vous fatigu√© ou avez-vous un manque d‚Äô√©nergie ?" },

  // Section 5 TOC
  { section: 5, text: "R√©p√©tez-vous certains gestes, comme vous laver les mains, compter, v√©rifier ou organiser des objets ? (Si non, passez √† la section suivante)" },
  { text: "Ces comportements sont-ils effectu√©s en r√©ponse √† une pens√©e obsessionnelle ou une peur ?" },
  { text: "Ces pens√©es ou comportements occupent-ils plus d‚Äôune heure par jour ou perturbent-ils significativement votre vie quotidienne ?" },

  // Section 6 Irritabilit√© et col√®re
  { section: 6, text: "√ätes-vous facilement irritable ou en col√®re ?" },
  { text: "Estimez-vous que vos acc√®s de col√®re sont disproportionn√©s par rapport √† la situation ?" },

  // Section 7 Maniaque/Hypomaniaque
  { section: 7, text: "Traversez-vous des p√©riodes o√π vous vous sentez particuli√®rement √©nergique, euphorique ou surexcit√©(e) ?" },
  { text: "Lors de ces p√©riodes, avez-vous tendance √† entreprendre des activit√©s qui pourraient avoir des cons√©quences n√©gatives ?" },

  // Section 8 Dissociation
  { section: 8, text: "Vous arrive-t-il de vous sentir d√©tach√© de vous-m√™me ou de votre environnement ?" },
  { text: "Avez-vous d√©j√† ressenti une impression d‚Äôirr√©alit√© √† propos de votre environnement ?" },

  // Section 9 M√©moire
  { section: 9, text: "Rencontrez-vous des difficult√©s de m√©moire, comme oublier des informations ou perdre le sens de l‚Äôorientation (par exemple, retrouver votre chemin) ?" },

  // Section 10 Impact fonctionnel et soutien
  { section: 10, text: "Dans quelle mesure ces difficult√©s ont-elles affect√© votre capacit√© √† travailler, √† vous occuper de votre domicile ou √† entretenir des relations avec autrui ?" },
  { text: "√Ä quel point estimez-vous que votre situation de vie actuelle et vos relations sociales vous apportent du soutien ?" },

  // Section 11 Substances
  { section: 11, text: "Utilisez-vous du tabac, de l‚Äôalcool, des drogues ou de la caf√©ine ? Si oui, veuillez indiquer la fr√©quence et la quantit√©." },

  // Section 12 Sant√© physique/douleurs
  { section: 12, text: "Ressentez-vous des douleurs chroniques ou un inconfort physique ? Si oui, merci de pr√©ciser." },
  { text: "Y a-t-il d‚Äôautres sympt√¥mes physiques que vous avez remarqu√©s et qui vous pr√©occupent ?" },
  { text: "Comment √©valueriez-vous votre √©tat de sant√© physique global (mauvais, passable, bon, tr√®s bon, excellent) ?" },

  // Section 13 Suicidaire
  { section: 13, text: "Avez-vous eu des pens√©es selon lesquelles il vaudrait mieux √™tre mort ou vous blesser d‚Äôune quelconque mani√®re ?" },

  // Section 14 Sommeil
  { section: 14, text: "Comment √©valueriez-vous la qualit√© g√©n√©rale de votre sommeil ?" },
  { text: "√âprouvez-vous des difficult√©s √† vous endormir ou √† rester endormi durant la nuit ?" },
  { text: "Vous r√©veillez-vous le matin en vous sentant repos√© ou encore fatigu√© ?" },
  { text: "Avez-vous des troubles du sommeil, tels que des cauchemars, du somnambulisme ou des r√©veils fr√©quents ?" },
  { text: "Utilisez-vous des m√©dicaments ou des substances pour faciliter le sommeil ?" },
  { text: "Des changements de mode de vie ou des √©v√©nements r√©cents ont-ils modifi√© votre rythme de sommeil ?" },

  // Section 15 Activit√© physique
  { section: 15, text: "√Ä quelle fr√©quence pratiquez-vous une activit√© physique ou de l‚Äôexercice ?" },

  // Section 16 Antecedents psychiatriques
  { section: 16, text: "Un diagnostic de trouble psychique a-t-il d√©j√† √©t√© pos√© auparavant ?" },
  { text: "Un traitement pour des difficult√©s psychiques a-t-il d√©j√† √©t√© suivi (th√©rapie, conseil, m√©dication) ? Si oui, merci de pr√©ciser." },

   // Section 17 Psychose
  { section: 17, text: "Avez-vous per√ßu des voix que les autres ne semblent pas entendre ?" },
  { text: "Avez-vous eu des croyances ou des id√©es que d‚Äôautres personnes consid√®rent comme √©tranges ou inhabituelles ?" },

  // Section 18 Alimentaire
  { section: 18, text: "Vous arrive-t-il de vous inqui√©ter de fa√ßon excessive pour votre poids ou votre apparence corporelle ?" },
  { text: "Avez-vous eu des √©pisodes de restriction alimentaire importante, de vomissements volontaires, ou de prises alimentaires excessives et incontr√¥lables ?" },

  // Section 19 Sexuel
  { section: 19, text: "Avez-vous constat√© une baisse notable de votre int√©r√™t ou de votre satisfaction concernant votre sexualit√© ?" },

  // Section 20 PTSD
  { section: 20, text: "Avez-vous √©t√© expos√© √† un √©v√©nement traumatique qui continue √† vous perturber (cauchemars, flashbacks, √©vitement) ?" },
  { text: "Pr√©sentez-vous des r√©actions de stress importantes en lien avec des souvenirs douloureux ?" },

  // Section 21 Hyperativit√©/attention
  { section: 21, text: "Rencontrez-vous souvent des difficult√©s √† rester concentr√©, √† terminer ce que vous commencez, ou √† rester en place ?" },
  { text: "√ätes-vous fr√©quemment distrait ou ressentez-vous une agitation int√©rieure ou physique inhabituelle ?" },

  // Section 22 Maltraitance
  { section: 22, text: "Avez-vous √©t√© expos√© √† des situations de violence ou de maltraitance ? Si oui, souhaitez-vous en parler ?" },

  // Section 23 Objectifs de la consultatation
  { section: 23, text: "Y a-t-il un sujet sp√©cifique que vous souhaitez aborder lors de la consultation ?" },
  { text: "Quels sont vos objectifs ou attentes en consultant actuellement ?" }

// --- fin des questions
];

// ici FINIT le module des questions

// ---------------------------------
// FIN CHOIX DU MODULE
// ---------------------------------

let responses = [];
let current = 0, codePerso = "", autoNextTimeout = null, frenchVoice = null, consigneVocaleDejaLue = false;
let correctionResumeMode = false; // Pour correction depuis le r√©sum√©
let delaiRecoRelance = 5000; // (en ms) D√©lai entre deux relances micro

const mainDiv = document.getElementById("main");
const introText = document.getElementById("introText");
const codeInput = document.getElementById("codeInput");
const startBtn = document.getElementById("startBtn");
const questionnaireDiv = document.getElementById("questionnaire");
const partLabel = document.getElementById("partLabel");
const questionEl = document.getElementById("question");
const summaryDiv = document.getElementById("summary");
const answersList = document.getElementById("answersList");
const copyBtn = document.getElementById("copyBtn");
const pdfBtn = document.getElementById("pdfBtn");
const commentGlobal = document.getElementById("globalComment");
const vocalTip = document.getElementById("vocalTip");
const statusDiv = document.getElementById("status");

// voici les questions √† r√©ponses qualitatives et quantitatives (min 1- 5 max)
const notables = [
  5, 6, 7, 8, 9, 10,
  11, 12, 13,
  14, 15, 16,
  17, 18,
  19, 20,
  21, 22,
  23,
  24, 25,
  27, 28,
  29,
  30, 31, 32, 33, 34, 35,
  36,
  37, 38,
  39, 40,
  41, 42,
  43,
  44, 45,
  46, 47,
  48,
  49, 50
];

// --- Synth√®se vocale ---
window.speechSynthesis.onvoiceschanged = function() {
  const voices = window.speechSynthesis.getVoices();
  frenchVoice = voices.find(v => v.lang.startsWith("fr"));
};
// Fonction synth√®se vocale
function speak(txt, cb) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();

  // Nettoyage du HTML pour √©viter que les balises comme <b> soient lues
  const tmp = document.createElement("div");
  tmp.innerHTML = txt;
  const cleanText = tmp.textContent || tmp.innerText || "";

  const utter = new SpeechSynthesisUtterance(cleanText);

  utter.lang = "fr-FR";
  if (frenchVoice) utter.voice = frenchVoice;
  if (typeof cb === "function") utter.onend = cb;
  window.speechSynthesis.speak(utter);
}

// --------------------
// Fonction de v√©rification support navigateur
// --------------------
function checkSpeechRecognitionSupport() {
  return ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
}

// --------------------
// Instance unique de reconnaissance vocale pour toute la session
// --------------------
let recognition = null;

if (('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window)) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = "fr-FR";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
}

// --------------------
// Fonction qui d√©marre la reconnaissance et utilise toujours la m√™me instance
// --------------------
function startRecognition(callback) {
  if (!recognition) {
    alert("Reconnaissance vocale non support√©e");
    callback("");
    return;
  }

  // Important : on enl√®ve les anciens ecouteurs d'evenements pour √©viter les doublons
  recognition.onresult = null;
  recognition.onerror = null;
  recognition.onend = null;

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript.trim();
    callback(transcript);
  };
  recognition.onerror = function(event) {
    callback(""); // Pour relancer ou corriger
  };
  recognition.onend = function() {
    // Rien √† faire ici, sauf si tu veux relancer la reco auto
  };
  recognition.start();
}

// ---------------------------------
// CHARGEMENT DYNAMIQUE DU MODULE DE QUESTIONS
// ---------------------------------
document.getElementById('btnCommencer').onclick = function() {
  let fichier = document.getElementById("moduleSelect").value;
  // Supprimer un ancien module si d√©j√† charg√©
  let oldScript = document.getElementById("dynamicModule");
  if (oldScript) oldScript.remove();

  // Charger le nouveau module (questions.js, etc.)
  let script = document.createElement('script');
// version du fichier, ici version 32
  script.src = fichier+"?v=32";
  script.id = "dynamicModule";
  script.onload = function() {
    // Lancer le questionnaire apr√®s le chargement du module
    if (typeof questions !== "undefined" && questions.length > 0) {
      // D√©marrage classique du quiz (intro ou direct)
      mainDiv.style.display = "none";
      questionnaireDiv.style.display = "block";
      askQuestion(0);
    } else {
      alert("Le module de questions n'a pas pu √™tre charg√©.");
    }
  };
  document.body.appendChild(script);
};

// ---------------------------------
// (fonction askQuestion commence ici‚Ä¶)
// ---------------------------------


// -----------------------------------------------------------------
// Affichage d'une question (zone r√©ponse, boutons, micro, dynamique)
// -----------------------------------------------------------------
function askQuestion(idx) {
// assigne la question actuelle
let q = questions[idx];
  let texte = q.text;
// ajout automatique de la consigne pour les questions notables
  if (notables.includes(idx)) {
texte += `<br><span style="color: #666; font-size: 0.9em; font-style: italic;">D√©crivez, et notez de 1 (non) √† 5 (max).</span>`;
  }
// Affiche le numero de question + le texte enrichi
questionEl.innerHTML = `${idx + 1}/${questions.length} ‚Äì ${texte}`;

// Optionnel: affichage du label de section- desactiv√© ici
// if (q.section && (idx === 0 || q.section !== questions[idx - 1].section)) {
//   partLabel.textContent = "Section " + q.section;
// } else {
  partLabel.textContent = "";
//)
// fin de la fonction assigner

// prepare l'accumulation du texte pour la reconnaissance voclae
  let transcriptAccumule = "";

  // Affiche le num√©ro de section UNIQUEMENT si nouvelle section (pas de nom de section)
  if (
    typeof questions[idx].section === "number" &&
    (idx === 0 || questions[idx].section !== questions[idx - 1].section)
  ) {
    partLabel.textContent = "Section " + questions[idx].section;
  } else {
    partLabel.textContent = "";
  }

  // Affiche TOUJOURS le num√©ro de la question (ex : 7/52 ‚Äì ...)
  //questionEl.innerHTML = `${idx + 1}/${questions.length} ‚Äì ${questions[idx].text}`;

  // Conseils et instructions √† afficher √† chaque question
  vocalTip.style.display = "block";
 vocalTip.innerHTML = '<b>Au clavier‚ÄØ:</b> Terminez votre r√©ponse par la touche <span style="color:#0056cc;font-weight:bold;">RETOUR</span>.<br>' +
  '<b>En vocal‚ÄØ:</b> Terminez en disant "<span style="color:#0056cc;font-weight:bold;">STOP</span>".';

  // ----------------------------------------------------------------
  // Cr√©ation dynamique de la zone de r√©ponse (textarea + boutons + micro)
  // ----------------------------------------------------------------
  let oldZone = document.getElementById("zoneResponse");
  if (oldZone) oldZone.remove();
  let responseZone = document.createElement("div");
  responseZone.id = "zoneResponse";
  responseZone.style.marginTop = "1.3em";

  // Cr√©ation du champ de r√©ponse (textarea responsive)
  input = document.createElement("textarea");
  input.id = "inputResponse";
  input.style.padding = "0.5em";
  input.style.fontSize = "1.2em";
  input.style.minHeight = "3em";
  input.style.resize = "vertical";
  input.placeholder = "R√©pondez ici ou utilisez le micro...";
  // Responsive largeur mobile/desktop
  input.style.width = "100%";
  input.style.maxWidth = "100vw";
  // Agrandit automatiquement le textarea selon la saisie
  input.addEventListener('input', function() {
    this.style.height = "auto";
    this.style.height = (this.scrollHeight) + "px";
  });
  // Restaure la r√©ponse d√©j√† saisie si existante
  if (responses[idx]) input.value = responses[idx];
  responseZone.appendChild(input);

  // ----------------------------------------------------------------
  
// Cr√©ation de la zone de correction/validation (Corriger, Pause, Valider)
// ----------------------------------------------------------------
let correctionZone = document.createElement("div");
correctionZone.style.marginTop = "0.7em";
responseZone.appendChild(correctionZone);

// Bouton "Corriger"
let btnCorriger = document.createElement("button");
btnCorriger.textContent = "Corriger";
btnCorriger.style.background = "#fb8c00";
btnCorriger.style.color = "#fff";
btnCorriger.style.marginRight = "1em";
btnCorriger.onclick = function() {
  input.value = "";
  input.focus();
};
correctionZone.appendChild(btnCorriger);

// Bouton "Pause"
let btnPause = document.createElement("button");
btnPause.textContent = "Pause";
btnPause.style.background = "#9486db";
btnPause.style.color = "#fff";
btnPause.style.marginRight = "1em";
btnPause.onclick = function() {
  alert("Pause activ√©e !");
};
correctionZone.appendChild(btnPause);

// Bouton "Valider"
let btnValider = document.createElement("button");
btnValider.textContent = "Valider";
btnValider.style.background = "#20b05a";
btnValider.style.color = "#fff";
btnValider.style.marginRight = "1em";
btnValider.onclick = function() {
  responses[idx] = input.value.trim();
  correctionZone.innerHTML = ""; // Vide la zone des boutons
  afficherPauseEtCorriger(input.value.trim());
};
correctionZone.appendChild(btnValider);

  // ----------------------------------------------------------------
  // Validation clavier (Entr√©e)
  // Entr√©e : valide et affiche Pause/Corriger dynamiquement
  // Shift+Entr√©e : retour √† la ligne
  // ----------------------------------------------------------------
  input.addEventListener("keydown", function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      responses[idx] = input.value.trim();
      correctionZone.innerHTML = "";
      afficherPauseEtCorriger(input.value.trim());
    }
  });

  // -----------------------------------------------------------------
  // Ajout du bouton micro EN BAS de la zone r√©ponse (jamais cach√© sur mobile)
  // -----------------------------------------------------------------
  let btnVocal = document.createElement("button");
  btnVocal.type = "button";

// Fonction de mise √† jour dynamique du texte selon l'√©tat du micro
function majTexteBtnMicro() {
 if (!checkSpeechRecognitionSupport()) {
    // Cas navigateur non support√©
    btnVocal.innerHTML =
      '<span style="color:#b30000;">Micro non support√© par ce navigateur üòï</span>';
    btnVocal.disabled = true;

  } else if (!microActif) {
    // Micro d√©sactiv√© volontairement (clavier uniquement)
    btnVocal.innerHTML =
      '<span>üîá Micro ferm√©, clavier seulement</span>' +
      '<span style="font-size:0.97em;color:#1976d2;margin-top:2px;">Cliquez pour activer le micro</span>';
    btnVocal.disabled = false;

  } else if (
    typeof recognition !== "undefined" &&
    recognition &&
    recognition.state === "inactive" // certains navigateurs supportent .state
  ) {
    // Micro inactif selon l‚ÄôAPI (cas rare mais g√©r√©)
    btnVocal.innerHTML =
      '<span>üé§ R√©ponse orale</span>' +
      '<span style="font-size:0.97em;color:#b30000;margin-top:2px;">Micro d√©sactiv√© ? Cliquez pour activer</span>';
    btnVocal.disabled = false;

  } else {
    // Cas g√©n√©ral‚ÄØ: micro actif, pr√™t √† √©couter
    btnVocal.innerHTML =
      '<span>üé§ R√©ponse orale</span>' +
      '<span style="font-size:0.97em;color:#b30000;margin-top:2px;">Cliquez ici pour r√©pondre par la voix</span>';
    btnVocal.disabled = false;
  }
}

majTexteBtnMicro();

btnVocal.id = "btnVocal";
btnVocal.style.display = "flex";
btnVocal.style.flexDirection = "column";
btnVocal.style.alignItems = "center";
btnVocal.style.marginTop = "1.5em";
btnVocal.style.marginLeft = "1em";
btnVocal.style.lineHeight = "1.3";
responseZone.appendChild(btnVocal);


  // ----------------------------------------------------------------
  // Insertion de la zone de r√©ponse dans le DOM et focus
  // ----------------------------------------------------------------
  questionEl.parentNode.appendChild(responseZone);
  input.focus();

  // ----------------------------------------------------------------
  // Relance la reconnaissance vocale au clic sur le bouton micro
  // ----------------------------------------------------------------
 btnVocal.onclick = function() {
  // Si le micro est support√©
if (checkSpeechRecognitionSupport()) {
    microActif = !microActif;
    majTexteBtnMicro();
    correctionZone.innerHTML = "<i>" + (microActif
      ? "Micro activ√©‚ÄØ: vous pouvez r√©pondre √† l'oral."
      : "Micro d√©sactiv√©‚ÄØ: saisie au clavier uniquement.") + "</i>";

    // Si le micro vient d'√™tre activ√©, on relance la reco imm√©diatement
    if (microActif) {
      autoRecognition(0);
     } else {
      input.focus(); // <-- Place le curseur dans le champ de r√©ponse
    }
  }
};

// ----------------------------------------------------------------
// Fonction pour lancer la reco vocale uniquement si microActif
// ----------------------------------------------------------------
function lancerRecoSiActif() {
  if (microActif) autoRecognition(0);
}

// ----------------------------------------------------------------
// Lance la consigne vocale une seule fois au d√©but
// ----------------------------------------------------------------
if (!consigneVocaleDejaLue) {
  consigneVocaleDejaLue = true;
  speak("Pour valider, terminez chaque r√©ponse en disant stop.", function() {
    speak(stripHTML(questions[idx].text), lancerRecoSiActif);
  });
} else {
  speak(stripHTML(questions[idx].text), lancerRecoSiActif);
}
  // ----------------------------------------------------------------
  // Fonction de reconnaissance vocale automatique, avec relances
  // ----------------------------------------------------------------
  function autoRecognition(relanceCount = 0) {
    // ajuste le nombre de relances - en general 10 mais maintenant 20, peut √™tre plus !
    const maxRelances = 20;
    btnVocal.disabled = true;
    startRecognition(function(rep) {
      btnVocal.disabled = false;
      if (rep && rep.trim()) {
        transcriptAccumule += " " + rep.trim();

        // rep d√©tecte-t-on un mot de fin ? (stop, termin√©, fin)
        let endsWithMotCle = transcriptAccumule.match(/\b(stop|termin√©|fin)\b[\s.?!]*$/i);
        let cleanRep = transcriptAccumule.replace(/\b(stop|termin√©|fin)\b[\s.?!]*$/i, '').trim();

        if (endsWithMotCle) {
          // Si r√©ponse vide apr√®s mot-cl√©, on valide quand m√™me
          input.value = cleanRep;
          responses[idx] = cleanRep;
          correctionZone.innerHTML = "";
          afficherPauseEtCorriger(cleanRep);
        } else if (relanceCount < maxRelances) {
          // On attend que l'utilisateur dise le mot de fin
          input.value = transcriptAccumule + " ...";
          afficherZoneValiderOuAttente("En attente de la fin de votre r√©ponse (dites \"stop\")...");
          setTimeout(() => autoRecognition(relanceCount + 1), delaiRecoRelance);
        } else {
          // Apr√®s trop de relances, invite √† valider ou recommencer
          afficherZoneValiderOuAttente("Aucun mot de fin d√©tect√© apr√®s plusieurs tentatives. Vous pouvez valider ou recommencer.");
        }
      } else {
        if (relanceCount < maxRelances) {
          // Pas de son reconnu, relance la reco
          afficherZoneValiderOuAttente("Je n'ai rien entendu. R√©pondez √† nouveau ou validez si tout est correct.");
          setTimeout(() => autoRecognition(relanceCount + 1), delaiRecoRelance);
        } else {
          // Apr√®s trop de tentatives sans r√©ponse, invite √† valider ou r√©essayer
          afficherZoneValiderOuAttente("Aucune r√©ponse d√©tect√©e apr√®s plusieurs tentatives. Vous pouvez valider ou r√©essayer.");
        }
      }
    });

    // ------------------------------------------------------------
    // Affiche les boutons de validation et de correction lors des relances
    // ------------------------------------------------------------
    function afficherZoneValiderOuAttente(message) {
      correctionZone.innerHTML = `
        <button id="btnValiderManuel" style="background:#20b05a;">Valider</button>
        <button id="btnCorrigerReco" style="background:#fb8c00;margin-left:1em;">Corriger</button>
        <div style="margin-top:0.5em;color:#b30000;">${message}</div>
      `;
      // Validation manuelle par clic sur "Valider"
      document.getElementById("btnValiderManuel").onclick = function() {
        responses[idx] = input.value.trim();
        correctionZone.innerHTML = "";
        transcriptAccumule = "";
        afficherPauseEtCorriger(input.value.trim());
      };
      // Correction manuelle par clic sur "Corriger"
      document.getElementById("btnCorrigerReco").onclick = function() {
        input.value = "";
        transcriptAccumule = "";
        correctionZone.innerHTML = "";
        setTimeout(() => autoRecognition(0), 400);
      };
    }
  }

  // ----------------------------------------------------------------
  // Fonction qui affiche les boutons PAUSE/REPRENDRE et CORRIGER,
  // et g√®re le passage automatique √† la question suivante
  // ----------------------------------------------------------------
  function afficherPauseEtCorriger(currentRep) {
    // Calcul du d√©lai dynamique selon la longueur de la r√©ponse
    let cleanLength = currentRep.length;
    let minDelay = 1200;
    let maxDelay = 9000;
    let msParCaractere = 40;
    let delay = Math.min(maxDelay, minDelay + cleanLength * msParCaractere);

    // Ajout du bouton Corriger
    let btnRetry = document.createElement("button");
    btnRetry.textContent = "Corriger";
    btnRetry.style.background = "#fb8c00";
    btnRetry.style.marginLeft = "1em";
    correctionZone.appendChild(btnRetry);

    // Ajout du bouton PAUSE/REPRENDRE
    let btnPause = document.createElement("button");
    btnPause.textContent = "Pause";
    btnPause.style.background = "#7a7adb";
    btnPause.style.marginLeft = "1em";
    correctionZone.appendChild(btnPause);

    // Gestion du timer et du bouton Pause/Reprendre
    let timerPaused = false;
    let remainingTime = delay;
    let timerStart = Date.now();
    let passageAuto;
    let input; //rend la variable globale
    function startTimer() {
    let input = document.getElementById("inputResponse"); // ‚¨ÖÔ∏è obligatoire
      passageAuto = setTimeout(function() {
     //Verification pour les questions notables avant de passer √† la question suivante
     if (notables.includes(current)) {
     let reponse=input.value.trim();   
     let match = reponse.match(/([1-5])\s*$/);//note entre 1 et 5 a la fin de la reponse
        if (!match) {
          correctionZone.innerHTML = `
            <div style="color:#b30000;margin-top:0.8em;">
              Merci d'ajouter une note entre 1 (NON) et 5 (max) √† la fin de votre r√©ponse.
            </div>
            <button id="btnCorrigerNote" style="background:#fb8c00;margin-top:1em;">Corriger la note</button>
          `;
          document.getElementById("btnCorrigerNote").onclick = function() {
            input.focus();
            input.setSelectionRange(input.value.length, input.value.length);
          };
          return; // ‚õî stop ici Ne pas passer √† la question suivante
        }
      }
//si reponse OK continuer normalement
        transcriptAccumule = "";
        if (correctionResumeMode) {
          correctionResumeMode = false;
          showSummary();
        } else {
          nextQuestionOrSummary();
        }
      }, remainingTime);
      timerStart = Date.now();
    }

    function pauseTimer() {
      clearTimeout(passageAuto);
      remainingTime -= (Date.now() - timerStart);
      timerPaused = true;
      btnPause.textContent = "Reprendre";
    }

    function resumeTimer() {
      timerPaused = false;
      btnPause.textContent = "Pause";
      startTimer();
    }

    btnPause.onclick = function() {
      if (!timerPaused) {
        pauseTimer();
      } else {
        resumeTimer();
      }
    };

    startTimer();

    // Si on clique "Corriger", on annule le passage auto et on relance la reco ou r√©affiche la zone clavier
    btnRetry.onclick = function() {
      clearTimeout(passageAuto);
      input.value = "";
      transcriptAccumule = "";
      correctionZone.innerHTML = "";
      setTimeout(() => autoRecognition(0), 400);
    };
  }
}

// Fonction utilitaire pour nettoyer le HTML pour la synth√®se vocale 
// (retire toute balise, ne garde que le texte brut)
function stripHTML(html) {
  let div = document.createElement("div");
  div.innerHTML = html;
  return div.textContent || div.innerText || "";
}

//-----------------
// Fonction de gestion du passage √† la question suivante
// (ou affichage du r√©sum√© √† la fin du questionnaire)
// ---------------------------------------------------------
function nextQuestionOrSummary() {
  if (++current < questions.length) askQuestion(current);
  else showSummary();
}

function showSummary() {
  questionnaireDiv.style.display = "none";
  summaryDiv.style.display = "block";
  answersList.innerHTML = "";
  questions.forEach((q, i) => {
    const li = document.createElement("li");
    li.innerHTML = `<b>Section ${q.section || ""}</b> ‚Äî ${q.text} : <span id="rep${i}">${responses[i] ? responses[i] : "<em>(Aucune r√©ponse)</em>"}</span> `;
    let btnCorriger = document.createElement("button");
    btnCorriger.textContent = "Corriger";
    btnCorriger.style.marginLeft = "1em";
    btnCorriger.onclick = function() {
      summaryDiv.style.display = "none";
      questionnaireDiv.style.display = "block";
      current = i;
      correctionResumeMode = true;
      askQuestion(i);
    };
    li.appendChild(btnCorriger);
    answersList.appendChild(li);
  });
}

window.onload = function() {
  document.getElementById('btnCommencer').onclick = function() {
    document.getElementById('btnCommencer').style.display = 'none';

// Affichage de l'intro avec innerHTML
introText.innerHTML = `<p>Je vais vous poser une liste de 52 questions se rapportant √† ces derni√®res semaines.</p>
<p>Ces questions sont r√©parties en 23 sections.</p>
<p>Vous pouvez r√©pondre en tapant sur le clavier ou si votre appareil le permet, en r√©pondant vocalement</p>
<p>Parlez lentement et distinctement si vous utilisez le micro, mais terminez toujours en disant <b>"STOP"</b> quand vous avez fini. Vous pouvez aussi faire une pause ou ajouter un commentaire.</p>
<p>Si votre appareil demande "ce site veut utiliser le micro", r√©pondez <b>autoriser</b>.</p>
<p>En cas d‚Äôerreur, vous pouvez utiliser le micro ou saisir votre r√©ponse au clavier.</p>
<p>√Ä la fin, un commentaire global est possible et vous pourrez corriger, copier vos r√©ponses ou les enregistrer en PDF gr√¢ce aux boutons pr√©vus √† cet effet.</p>
<p><b>Entrez maintenant un code √† 4 chiffres de votre choix en les tapant sur le clavier.</b></p>`;

    document.getElementById('intro').style.display = "block";
    setTimeout(function() {
      speak("Je vais vous poser une liste de 52 questions se rapportant √† ces derni√®res semaines. Ces questions sont r√©parties en 23 sections. Vous pouvez r√©pondre en tapant sur le clavier ou, si votre appareil le permet,  en r√©pondant vocalement. Parles lentement et distinctement si vous utilisez le micro mais terminez toujours en disant, STOP, quand vous avez fini. Vous pouvez aussi faire une pause ou ajouter un commentaire. Si votre appareil demande 'ce site veut utiliser le micro, r√©pondez autoriser'. En cas d‚Äôerreur, vous pouvez utiliser le micro ou saisir votre r√©ponse au clavier. √Ä la fin, un commentaire global est possible et vous pourrez corriger, copier vos r√©ponses ou les enregistrer en PDF gr√¢ce aux boutons pr√©vus √† cet effet. Entrez maintenant un code √† 4 chiffres de votre choix en les tapant sur le clavier.", function() {
        codeInput.focus();
      });
    }, 300);
  };
  startBtn.onclick = function() {
    const code = codeInput.value.trim();
    if (!/^\d{4}$/.test(code)) {
      statusDiv.textContent = "Veuillez entrer un code √† 4 chiffres.";
      return;
    }
    codePerso = code;
    mainDiv.style.display = "none";
    questionnaireDiv.style.display = "block";
    current = 0;
    responses = [];
    askQuestion(current);
  };
  // Permettre Entr√©e pour d√©marrer apr√®s le code
  codeInput.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      startBtn.click();
    }
  });
// Toutes les reponses du questionnaire copi√©es dans le presse-papier (pour coller dans un  mail)
  copyBtn.onclick = function() {
    const txt = "Code : " + codePerso + "\n"
      + questions.map((q, i) => "Section " + (q.section||"") + " ‚Äî " + q.text + " : " + (responses[i] || "(Aucune r√©ponse)")).join("\n")
      + "\nCommentaire global : " + commentGlobal.value;
    navigator.clipboard.writeText(txt);
    alert("R√©ponses copi√©es !");
  };
// impression PDF de la page entiere (y compris le resum√©)
  pdfBtn.onclick = function() { window.print(); };
};
</script>
<! ---Affichage discret de la version en bas de page ---> 
<footer style="text-align:center; font-size:0.85em; color:#aaa; margin-top:2em;">
  Version 32 ‚Äì &copy; 2024 SwedSleep
</footer>
</body>
</html>
